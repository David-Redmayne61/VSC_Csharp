@model UserManagementViewModel
@{
    ViewData["Title"] = "User Management";
}

<div class="container">
    <h2>User Management</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Create New User</h4>
                </div>
                <div class="card-body">
                    <form asp-controller="Admin" asp-action="CreateUser" method="post">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="All" class="text-danger"></div>

                        <div class="mb-3">
                            <label asp-for="NewUser.Username" class="form-label">Username</label>
                            <input name="Username" class="form-control" value="@Model.NewUser.Username" />
                            <span asp-validation-for="NewUser.Username" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewUser.Password" class="form-label">Password</label>
                            <input name="Password" type="password" class="form-control" />
                            <div id="passwordStrength" class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="passwordFeedback" class="form-text text-muted"></small>
                            <span asp-validation-for="NewUser.Password" class="text-danger"></span>
                            <div class="form-text">Password must be 8-12 characters and contain uppercase, lowercase, and numbers.</div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewUser.ConfirmPassword" class="form-label">Confirm Password</label>
                            <input name="ConfirmPassword" type="password" class="form-control" />
                            <span asp-validation-for="NewUser.ConfirmPassword" class="text-danger"></span>
                        </div>

                        <button type="submit" class="btn btn-primary" onclick="this.disabled=true;this.form.submit();">
                            <i class="bi bi-person-plus"></i> Create User
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Existing Users (@Model.Users.Count())</h4>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.Users)
                            {
                                <tr>
                                    <td>@user.Username</td>
                                    <td>@user.Created.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        @if (user.Username.ToLower() != "admin")
                                        {
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-warning btn-sm" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal" 
                                                        data-userid="@user.Id"
                                                        data-username="@user.Username">
                                                    <i class="bi bi-key"></i> Reset Password
                                                </button>
                                                <form asp-action="DeleteUser" asp-controller="Admin" method="post" style="display: inline;">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="userId" value="@user.Id" />
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                            onclick="return confirm('Are you sure you want to delete user \'@user.Username\'?')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="badge bg-primary">Admin</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="ResetUserPassword" asp-controller="Admin" method="post" id="resetPasswordForm">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Reset User Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="UserId" name="UserId" />
                    <input type="hidden" id="Username" name="Username" />
                    
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <p>Reset password for user: <strong id="displayUsername"></strong></p>
                    
                    <div class="mb-3">
                        <label for="NewPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="NewPassword" name="NewPassword" required 
                               minlength="8" maxlength="12" />
                        <div id="resetPasswordStrength" class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="resetPasswordFeedback" class="form-text text-muted"></small>
                        <div class="form-text">Password must be 8-12 characters and contain uppercase, lowercase, and numbers.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword" required 
                               minlength="8" maxlength="12" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" onclick="this.disabled=true;this.form.submit();">
                        <i class="bi bi-key"></i> Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Add form submit handler
        document.getElementById('resetPasswordForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Log form data
            console.log('Form submission:', {
                userId: document.getElementById('UserId').value,
                username: document.getElementById('Username').value,
                newPassword: document.getElementById('NewPassword').value,
                confirmPassword: document.getElementById('ConfirmPassword').value
            });

            // Submit if validation passes
            if (this.checkValidity()) {
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                this.submit();
            }
        });

        document.getElementById('resetPasswordModal').addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var userId = button.getAttribute('data-userid');
            var username = button.getAttribute('data-username');
            
            // Reset form validation
            var form = document.getElementById('resetPasswordForm');
            form.reset();
            
            document.getElementById('UserId').value = userId;
            document.getElementById('Username').value = username;
            document.getElementById('displayUsername').textContent = username;
        });

        // Password strength meter for reset password
        document.getElementById('NewPassword').addEventListener('input', function() {
            const password = this.value;
            const progressBar = document.querySelector('#resetPasswordStrength .progress-bar');
            const feedback = document.getElementById('resetPasswordFeedback');
            
            let strength = 0;
            let message = '';
            
            if (password.length >= 8) strength += 25;
            if (password.match(/[A-Z]/)) strength += 25;
            if (password.match(/[a-z]/)) strength += 25;
            if (password.match(/[0-9]/)) strength += 25;
            
            progressBar.style.width = strength + '%';
            
            if (strength <= 25) {
                progressBar.className = 'progress-bar bg-danger';
                message = 'Weak password';
            } else if (strength <= 50) {
                progressBar.className = 'progress-bar bg-warning';
                message = 'Moderate password';
            } else if (strength <= 75) {
                progressBar.className = 'progress-bar bg-info';
                message = 'Good password';
            } else {
                progressBar.className = 'progress-bar bg-success';
                message = 'Strong password';
            }
            
            feedback.textContent = message;
        });
    </script>
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">